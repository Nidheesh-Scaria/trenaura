
<head>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  {{!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> --}}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css"/>
  
  <link rel="stylesheet" href="/css/adminCustomers.css">
  <style>
    .refresh-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: all 0.3s;
        background-color: #1d1c8a;
    }

    .refresh-btn i {
        margin-right: 5px;
    }

    .refresh-btn:hover {
        background-color:  #1916b3;
    }


    .table-container a{
      text-decoration: none;
    }
    .edit{
     color: #1916b3;
    }
    .delete{
      color: red;
    }
  .error-message {
    color: red;
    font-size: 0.9rem;
    margin-top: 4px;
  }
    


  /* Edit Modal Styles - Centered and Stable */
#editCategoryModal.modal {
  
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 0, 0, 0.5);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1050;
  overflow-y: auto;
}

#editCategoryModal .modal-dialog {
  position: relative;
  width: auto;
  max-width: 600px;
  margin: 0 auto;
  pointer-events: none;
  transition: none !important; /* Disable any movement transitions */
  transform: none !important; /* Disable any transform animations */
}

#editCategoryModal .modal-content {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 100%;
  pointer-events: auto;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 0.3rem;
  outline: 0;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

/* Modal Header */
#editCategoryModal .modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  border-bottom: 1px solid #e9ecef;
  background-color: #4361ee;
  color: white;
}

#editCategoryModal .modal-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 500;
}

#editCategoryModal .btn-close {
  padding: 0.5rem;
  margin: -0.5rem -0.5rem -0.5rem auto;
  background-color: transparent;
  border: 0;
  color: white;
  font-size: 1rem;
  cursor: pointer;
  opacity: 0.8;
}

#editCategoryModal .btn-close:hover {
  opacity: 1;
}

/* Modal Body */
#editCategoryModal .modal-body {
  position: relative;
  flex: 1 1 auto;
  padding: 1.5rem;
}

#editCategoryModal .form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

#editCategoryModal .form-control {
  display: block;
  width: 100%;
  padding: 0.375rem 0.75rem;
  font-size: 1rem;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

#editCategoryModal .form-control:focus {
  border-color: #4361ee;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
}

/* Modal Footer */
#editCategoryModal .modal-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 1rem;
  border-top: 1px solid #e9ecef;
}

#editCategoryModal .btn {
  display: inline-block;
  font-weight: 400;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  user-select: none;
  border: 1px solid transparent;
  padding: 0.375rem 0.75rem;
  font-size: 1rem;
  line-height: 1.5;
  border-radius: 0.25rem;
  transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
}

#editCategoryModal .btn-secondary {
  color: #fff;
  background-color: #6c757d;
  border-color: #6c757d;
  margin-right: 0.5rem;
}

#editCategoryModal .btn-primary {
  color: #fff;
  background-color: #4361ee;
  border-color: #4361ee;
}
.form-select {
   border: 1px solid #ced4da;
   border-radius: 4px;
   padding: 8px 12px;
   width: 100%;
 }


/* Responsive Adjustments */
@media (max-width: 768px) {
  #editCategoryModal .modal-dialog {
    max-width: 95%;
    margin: 0.5rem auto;
  }
}

/* Disable any movement animations */
.modal.fade .modal-dialog {
  transition: none !important;
  transform: none !important;
}


/* Delete Modal Styles - Fixed Centered Position */
#deleteCategoryModal.modal {
  
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 0, 0, 0.5);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1050;
  overflow-y: auto;
}

#deleteCategoryModal .modal-dialog {
  position: relative;
  width: auto;
  max-width: 500px;
  margin: 0 auto;
  pointer-events: none;
  transition: none !important;
  transform: none !important;
}

#deleteCategoryModal .modal-content {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 100%;
  pointer-events: auto;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 0.3rem;
  outline: 0;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  border-top: 4px solid #dc3545;
}

/* Modal Header */
#deleteCategoryModal .modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  border-bottom: 1px solid #e9ecef;
}

#deleteCategoryModal .modal-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 500;
  color: #dc3545;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#deleteCategoryModal .modal-title::before {
  content: "âš ";
  font-size: 1.2em;
}

#deleteCategoryModal .btn-close {
  padding: 0.5rem;
  margin: -0.5rem -0.5rem -0.5rem auto;
  background-color: transparent;
  border: 0;
  font-size: 1rem;
  cursor: pointer;
  opacity: 0.7;
}

#deleteCategoryModal .btn-close:hover {
  opacity: 1;
}

/* Modal Body */
#deleteCategoryModal .modal-body {
  position: relative;
  flex: 1 1 auto;
  padding: 1.5rem;
  text-align: center;
}

#deleteCategoryModal .modal-body p {
  margin: 0;
  font-size: 1.05rem;
  color: #6c757d;
}

/* Modal Footer */
#deleteCategoryModal .modal-footer {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  border-top: 1px solid #e9ecef;
  gap: 1rem;
}

#deleteCategoryModal .btn {
  display: inline-block;
  font-weight: 500;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  user-select: none;
  border: 1px solid transparent;
  padding: 0.5rem 1.25rem;
  font-size: 1rem;
  line-height: 1.5;
  border-radius: 0.25rem;
  transition: all 0.15s ease;
  min-width: 100px;
}

#deleteCategoryModal .btn-secondary {
  color: #fff;
  background-color: #6c757d;
  border-color: #6c757d;
}

#deleteCategoryModal .btn-danger {
  color: #fff;
  background-color: #dc3545;
  border-color: #dc3545;
  position: relative;
  overflow: hidden;
}

#deleteCategoryModal .btn-danger:hover {
  background-color: #c82333;
  border-color: #bd2130;
}

/* Disable any movement animations */
.modal.fade .modal-dialog {
  transition: none !important;
  transform: none !important;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  #deleteCategoryModal .modal-dialog {
    max-width: 95%;
    margin: 0.5rem auto;
  }
  
  #deleteCategoryModal .modal-footer {
    flex-direction: column-reverse;
    gap: 0.5rem;
  }
  
  #deleteCategoryModal .btn {
    width: 100%;
  }
}

@media (max-width: 576px) {
  #deleteCategoryModal .modal-title {
    font-size: 1.1rem;
  }
  
  #deleteCategoryModal .modal-body p {
    font-size: 0.95rem;
  }
}





  </style>

</head>
<body>
  <main class="main-content">
    <header class="header">
      <h1>Product Management</h1>
      <div class="header-icons">
        <img src="https://i.pravatar.cc/40" alt="Profile">
      </div>
    </header>

    <div class="content">
      <div class="search-container">
        <form action="/admin/products" method="GET" class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" name="search" value="{{search}}" style="border-radius: 20px;" placeholder="Search products...">
          <button type="button" class="clear-btn" title="Clear" onclick="window.location.href='/admin/products'">
            <span style="font-weight: 600;">X</span>
          </button>
        </form>

        <div class="d-flex gap-2 flex-wrap">
           <form method="GET" action="/admin/addProducts">
            <button id="refreshBtn" class="refresh-btn">
              &#43 Add Products
            </button>
          </form>
       
        </div>
      </div>

      <div class="table-container" >
        <table id="customerTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Image</th>
              <th>Products</th>
              <th>Price</th>
              <th>Sale Price</th>
              <th>Category</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody >
            {{#if products.length}}
              {{#each products}}
                <tr>

                  <td>{{this.serialNumber}}</td>
                  <td>
                    {{#if this.firstImage}}
                      <img src="/images/{{this.firstImage}}" alt="{{this.productName}}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                    {{else}}
                      <div style="width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999;">
                        No Image
                      </div>
                    {{/if}}
                  </td>
                  <td>{{this.productName}}</td>
                  <td>{{this.regularPrice}}</td> 
                  <td>{{this.salePrice}}</td>
                  <td>{{this.category}}</td>
                  <td>{{this.status}}</td>
                  <td class="d-flex gap-2 flex-wrap">
                    <a href="#" class="btn edit" style="" onclick="openEditModal('{{this._id}}', '{{this.productName}}', '{{this.regularPrice}}', '{{this.salePrice}}', '{{this.category}}')">Edit</a>
                    <a href="#" class="btn delete" onclick="openDeleteModal('{{this._id}}')">Delete</a>
                  </td>
                </tr>
              {{/each}}
            {{else}}
              <tr>
                <td colspan="8" style="text-align: center; padding: 20px;">No products found</td>
              </tr>
            {{/if}}
          </tbody>
        </table>
      </div>

      {{#if products.length}}
      <div class="pagination">
        {{#ifCond currentPage '>' 1}}
          <a href="?page={{decrement currentPage}}&search={{search}}" class="page-btn"><i class="fas fa-chevron-left"></i></a>
        {{else}}
          <button class="page-btn" disabled><i class="fas fa-chevron-left"></i></button>
        {{/ifCond}}

        {{#each (range 1 totalPages)}}
          {{#ifCond this '===' ../currentPage}}
            <span class="page-number current">{{this}}</span>
          {{else}}
            <a href="?page={{this}}&search={{../search}}" class="page-number">{{this}}</a>
          {{/ifCond}}
        {{/each}}

        {{#ifCond currentPage '<' totalPages}}
          <a href="?page={{increment currentPage}}&search={{search}}" class="page-btn"><i class="fas fa-chevron-right"></i></a>
        {{else}}
          <button class="page-btn" disabled><i class="fas fa-chevron-right"></i></button>
        {{/ifCond}}
      </div>
      {{/if}}

    
    </div>
  </main>

  <!-- Edit Product Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="editCategoryForm" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title">Edit Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="editCategoryId" />
              <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" id="editProductName" name="productName" class="form-control" />
                <div class="error-message" id="editProductName-error"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Regular Price</label>
                <input type="number" id="editRegularPrice" name="regularPrice" class="form-control" step="0.01" />
                <div class="error-message" id="editRegularPrice-error"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Sale Price</label>
                <input type="number" id="editSalePrice" name="salePrice" class="form-control" step="0.01"/>
                <div class="error-message" id="editSalePrice-error"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Category</label>
                <select class="form-select border" name="category" id="editCategory" class="form-control" >
                  {{#each categories}}
                    <option value="{{this._id}}">{{this.name}}</option>
                  {{/each}}
                </select>
                <div class="error-message" id="editCategory-error"></div>
              </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Current Images</label><br />
                <div class="d-flex flex-wrap gap-2 current-images-container">
                </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Upload New Images</label>
              <input type="file" name="images" multiple class="form-control" />
            </div>


                        
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>



  <!-- Delete Product Modal -->
  <div class="modal fade" id="deleteCategoryModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="deleteCategoryForm">
          <div class="modal-header">
            <h5 class="modal-title">Delete Product</h5>
            <input type="hidden" id="deleteCategoryId" />
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this product? This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>




{{#if successMessage}}
<script>
  Swal.fire({
    icon: 'success',
    title: 'Success!',
    text: '{{successMessage}}',
    confirmButtonColor: '#3085d6',
    timer: 2000,
    timerProgressBar: true
  });
</script>
{{/if}}

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function openEditModal(id, productName, regularPrice, salePrice, category) {

  fetch(`/admin/editProducts/${id}`)
    .then(response => {
      console.log('Response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Received data:', data);
      
      if (data.success) {
        const product = data.product;
        
        
        $('#editCategoryId').val(product._id);
        $('#editProductName').val(product.productName);
        $('#editRegularPrice').val(product.regularPrice);
        $('#editSalePrice').val(product.salePrice);
        $('#editCategory').val(product.category);
        
        // Clear previous images and show with current images
        $('.current-images-container').empty();
        
        if (product.productImages && product.productImages.length > 0) {
          product.productImages.forEach(function(image) {
            const imageHtml = `
              <div class="text-center">
                <img src="/images/${image}" width="100" class="mb-1" />
                <br />
                <input type="checkbox" name="deleteImages" value="${image}" /> Delete
              </div>
            `;
            $('.current-images-container').append(imageHtml);
          });
        } else {
          console.log('No product images found');
        }
        
        // Clear previous error messages
        $('.error-message').text('');
        
        // Showing modal
        $('#editCategoryModal').modal('show');
      } else {
        console.error('API returned error:', data.message);
        Swal.fire('Error', data.message || 'Failed to load product data', 'error');
      }
    })
    .catch(error => {
      console.error('Error fetching product:', error);
      Swal.fire('Error', 'Failed to load product data', 'error');
    });
}

//edit modal eith images
$('#editCategoryForm').on('submit', function (e) {
  e.preventDefault();
  
  // Clear previous error messages
  $('.error-message').text('');
  
  let isValid = true;
  
  const productName = $('#editProductName').val().trim();
  const regularPrice = parseFloat($('#editRegularPrice').val());
  const salePrice = parseFloat($('#editSalePrice').val());
  const category = $('#editCategory').val();
  const id = $('#editCategoryId').val();


  if (!productName) {
    $('#editProductName-error').text('Product name is required');
    isValid = false;
  }
  
  if (isNaN(regularPrice) || regularPrice <= 0) {
    $('#editRegularPrice-error').text('Regular price must be valid');
    isValid = false;
  }

  if (isNaN(salePrice) || salePrice <= 0) {
    $('#editSalePrice-error').text('Sale price must be valid');
   isValid = false;
  }
  
  
  if (regularPrice <= salePrice) {
    $('#editRegularPrice-error').text('Regular price must be greater than sale price');
    isValid = false;
  }

  if (!category) {
    $('#editCategory-error').text('Category is required');  
    isValid = false;
  }
  
  if (!isValid) {
    Swal.fire('Error', 'Please fix the errors in the form.', 'error');
    return;
  }

const form = document.getElementById('editCategoryForm');
const formData = new FormData(form);

  fetch(`/admin/editProducts/${id}`, {
    method: 'POST', 
    body: formData,
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        Swal.fire('Updated!', data.message, 'success').then(() => location.reload());
      } else {
        Swal.fire('Error', data.message, 'error');
      }
    })
    .catch(err => {
      console.error(err);
      Swal.fire('Error', 'Something went wrong', 'error');
    });
});


function openDeleteModal(id) {
  $('#deleteCategoryId').val(id);
  $('#deleteCategoryModal').modal('show');
}

$('#deleteCategoryForm').on('submit', function (e) {
  e.preventDefault();
  const id = $('#deleteCategoryId').val();

  fetch(`/admin/deleteProducts/${id}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      Swal.fire('Deleted!', data.message, 'success').then(() => location.reload());
    } else {
      Swal.fire('Error', data.message, 'error');
    }
  });
});

</script>
