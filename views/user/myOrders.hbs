
<head>
  <style>
    /* Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      color: #333;
    }

    /* Empty Order */
    .order-empty {
      text-align: center;
      padding: 60px 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      margin: 80px auto;
    }

    .order-empty-title {
      font-size: 26px;
      font-weight: bold;
      color: #444;
      margin-bottom: 10px;
    }

    .order-empty-text {
      font-size: 16px;
      color: #777;
    }

    /* Container */
    .container {
      margin: 30px auto;
      max-width: 1200px;
      padding: 10px;
    }

    /* Main Content */
    .main-content {
      padding: 25px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.05);
    }

    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .orders-header h2 {
      font-size: 28px;
      font-weight: 700;
      color: #222;
    }

    /* Orders List */
    .orders-list {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .order-card {
      display: flex;
      align-items: center;
      background: #fff;
      padding: 18px;
      border-radius: 10px;
      gap: 18px;
      border: 1px solid #eee;
      transition: all 0.2s ease;
    }

    .order-card:hover {
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    .order-card img {
      width: 85px;
      height: 85px;
      object-fit: cover;
      border-radius: 8px;
      background: #f0f0f0;
    }

    .order-info {
      flex: 1;
    }

    .order-info h3 {
      font-size: 16px;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    .price-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .current-price {
      font-size: 16px;
      font-weight: bold;
      color: #222;
    }

    .original-price {
      text-decoration: line-through;
      color: #999;
      font-size: 14px;
    }

    /* Order Status */
    .order-status {
      text-align: right;
      min-width: 220px;
    }

    .status-text {
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .status-text.green {
      color: #28a745;
    }

    .status-text.red {
      color: #dc3545;
    }

    .status-text.orange {
      color: #ffc107;
    }

    .status-detail {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    /* Buttons */
    .buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .buttons button {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
    }

    .btn-primary {
      background: #333;
      color: #fff;
    }

    .btn-primary:hover {
      background: #111;
    }

    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #555;
    }

    .diabledButton {
      display: none;
    }

    /* Cancel Order Modal */
    #cancelOrderModal .modal-title {
      font-weight: 600;
      font-size: 20px;
      color: #ed0017;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #cancelOrderModal .modal-title::before {
      content: "‚ö†";
      font-size: 1.5em;
    }

    #cancelOrderModal .modal-footer .btn {
      min-width: 120px;
      border-radius: 6px;
    }

    #cancelOrderModal .btn-danger {
      font-weight: 500;
    }

    .cancel-label {
      font-weight: 600;
      font-size: 15px;
      color: #e20b0b;
      margin-bottom: 10px;
      display: block;
    }

    .cancel-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .cancel-options label {
      font-size: 14px;
      cursor: pointer;
    }

    .cancel-reason {
      padding-left: 5%;
    }

    #otherReason {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      resize: none;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 25px;
    }

    .page-btn,
    .page-number {
      display: inline-block;
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      color: #333;
      text-decoration: none;
      cursor: pointer;
      transition: 0.2s;
    }

    .page-btn:hover,
    .page-number:hover {
      background: #f0f0f0;
    }

    .page-number.current {
      background: #007bff;
      color: white;
      border-color: #007bff;
      font-weight: bold;
    }

    .page-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>

  <!-- Bootstrap + SweetAlert + Lottie -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>


<body>
  <div class="container">
    <main class="main-content">
      <div class="orders-header">
        <h2>My Orders</h2>
        {{!-- <div class="search-container">
          <input type="text" placeholder="Search orders">
          <span class="search-icon">üîç</span>
        </div> --}}
      </div>

      <div class="orders-list">
        <!-- If no orders -->
        {{#if isMyOrderEmpty}}
        <div class="order-empty">
          <h2 class="order-empty-title">No Orders Yet</h2>
          <p class="order-empty-text">Looks like you haven't placed any orders yet.</p>
        </div>
        {{/if}}

        <!-- Orders -->
        {{#each myOrder}}
        
        
        <div class="order-card">
          
          {{#each orderedItems}}
          <img src="/images/{{this.productImages.[0]}}" alt="{{this.productName}}">
          <div class="order-info">
            <h3>{{this.productName}}</h3>
            <div class="price-info">
              <span class="current-price">‚Çπ {{this.price}}</span>
              <span class="original-price">‚Çπ {{this.regularPrice}}</span>
            </div>
          </div>

          {{!--order status --}}  
          <div class="order-status">
            <div class="status-indicator">
              {{#if (eq this.statusHistory "Cancelled")}}
              <span style="color: #dc3545;" id="statusHistory-{{this.id}}">{{this.statusHistory}}</span>
                  {{#if this.isAdminCancelled}}
                  <p>Cancelled by admin</p>
                  {{/if}}
              {{else if (eq this.statusHistory "Delivered") }}
              <span style="font-weight: 900;" class="status-text green" id="statusHistory-{{this.id}}">{{this.statusHistory}}</span>
                {{#if (eq this.isReturnInitiated true)}}
                <p style="color: red;">Return requested</p>
                {{else if (eq this.isReturnInitiated false)}}
                <p style="color: red;">Return rejected</p>
                {{/if}}
              {{else}}
              <span class="status-text green" id="statusHistory-{{this.id}}">Will be delivered soon</span>
              {{/if}}
            </div>

            <div class="status-detail">Know updates</div>

            <div class="buttons">
              {{#if (eq this.statusHistory "Cancelled")}}
              <button class="diabledButton">Cancel Order</button>
              {{else if (eq this.statusHistory "Delivered")}}
              <button class="diabledButton" disabled></button>
              {{else}}
              <button id="cancelBtn-{{this.id}}" class="btn-secondary" onclick="openCancelModal('{{this.id}}')" {{#if
                (eq this.statusHistory "Cancelled" )}}style="display:none;" {{/if}}>
                Cancel Order
              </button>
              {{/if}}
              <button class="btn-primary" onclick="orderDetails(event,'{{this.id}}')">Details</button>
            </div>
          </div>
        </div>
        
        {{/each}}
        {{/each}}
      </div>
    </main>
    
   {{!-- Pagination --}}
   <div class="pagination" {{#if isMyOrderEmpty}}style="display:none;"{{/if}}>
      {{!-- Previous Button --}}
      {{#ifCond currentPage ">" 1}}
        <a href="?page={{decrement currentPage}}&search={{search}}" class="page-btn">
          <i class="fas fa-chevron-left"></i>
        </a>
      {{else}}
        <button class="page-btn" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
      {{/ifCond}}

      {{!-- Numbered Pages --}}
      {{#each (range 1 totalPages)}}
        {{#ifCond this "===" ../currentPage}}
          <span class="page-number current">{{this}}</span>
        {{else}}
          <a href="?page={{this}}&search={{../search}}" class="page-number">{{this}}</a>
        {{/ifCond}}
      {{/each}}

      {{!-- Next Button --}}
      {{#ifCond currentPage "<" totalPages}}
        <a href="?page={{increment currentPage}}&search={{search}}" class="page-btn">
          <i class="fas fa-chevron-right"></i>
        </a>
      {{else}}
        <button class="page-btn" disabled>
          <i class="fas fa-chevron-right"></i>
        </button>
      {{/ifCond}}
    </div>

  </div>




  <!-- Cancel Order Modal -->
  <div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="cancelOrderForm">
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Order?</h5>
                    <input type="hidden" id="cancelOrderId" />
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
                </div>
                <div class="cancel-reason">
                <div class="form-group">
                  <label class="cancel-label">Reason for cancellation</label>

                  <div class="cancel-options">
                    <label><input type="radio" name="cancelReason" value="ordered_by_mistake" onchange="toggleOtherReason(this)"> Ordered by mistake</label>
                    <label><input type="radio" name="cancelReason" value="found_better_price" onchange="toggleOtherReason(this)"> Found a better price</label>
                    <label><input type="radio" name="cancelReason" value="item_not_needed" onchange="toggleOtherReason(this)"> Item not needed</label>
                    <label><input type="radio" name="cancelReason" value="delivery_too_slow" onchange="toggleOtherReason(this)"> Delivery is taking too long</label>
                    <label><input type="radio" name="cancelReason" value="wrong_item_ordered" onchange="toggleOtherReason(this)"> Wrong item ordered</label>
                    <label>
                      <input type="radio" name="cancelReason" value="Other" onchange="toggleOtherReason(this)"> Other(Specify)
                    </label>
                  </div>
                  <p id="error-modal" style="color: #ff041d; "></p>
                </div>
                </div>

                <!-- Hidden text area for "Other" -->
                <div id="otherReasonContainer" style="display:none;">
                  <label for="otherReason"><span style="font-size: small;">Please specify:</span></label>
                  <textarea id="otherReason" name="otherReason" rows="3"></textarea>
                  
                </div>
               

                

                <div class="modal-footer">
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Order</button>
                    <button type="submit" class="btn btn-danger">Yes, Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>




<script>

  let currentCancelButton = null;
  function openCancelModal(id, btn) {
    currentCancelButton = btn;
    $("#cancelOrderId").val(id);
    $("#cancelOrderModal").modal("show");

    //cancell section
    document.querySelectorAll('input[name="cancelReason"]').forEach(radio => {
        radio.checked = false;
    });
        
    document.getElementById("otherReasonContainer").style.display = "none";
    document.getElementById("otherReason").value = "";
    document.getElementById("error-modal").innerText = "";;
  }


  $("#cancelOrderForm").on("submit", function (e) {
    e.preventDefault();
    const id = $("#cancelOrderId").val();
    document.getElementById("error-modal").innerText = "";
    if (currentCancelButton) currentCancelButton.disabled = true;

    const selectedReason=document.querySelector('input[name="cancelReason"]:checked')?.value
    
    //error display if no value selected

    if(!selectedReason){
      document.getElementById("error-modal").innerText="Please specify your reason.";
      return
    }
    //checking for other reason
    let reason=selectedReason
    if(selectedReason==="Other"){
      const otherText=document.getElementById("otherReason").value.trim()
      if(!otherText){
        document.getElementById("error-modal").innerText="Please specify your reason.";
        return
      }
      reason=otherText;
    }

    document.getElementById("error-modal").innerText = "";


    fetch(`cancelOrder/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: "Cancelled" ,reason:reason}),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          $("#cancelOrderModal").modal("hide");

          const statusEl = document.getElementById(`statusHistory-${id}`);
          if (statusEl) {
            statusEl.innerText = "Cancelled";
            statusEl.style.color = "#dc3545";
          }

          // Disable the cancel button
          const btn = document.getElementById(`cancelBtn-${id}`);

          if (btn) {
            btn.disabled = true;
            btn.classList.remove("btn-secondary");
            btn.classList.add("diabledButton");
          }

          Swal.fire("Cancelled!", data.message, "success");
        } else {
          Swal.fire("Error", data.message, "error");
          if (currentCancelButton) currentCancelButton.disabled = false;
        }
      })
      .catch(() => {
        Swal.fire("Error", "Something went wrong", "error");
        if (currentCancelButton) currentCancelButton.disabled = false;
      });
  });

  async function orderDetails(event, id) {
    event.preventDefault();
    window.location.href = `/orderDetails/${id}`;
  }


  function toggleOtherReason(radio) {
    const otherContainer = document.getElementById("otherReasonContainer");
    if (radio.value === "Other") {
      otherContainer.style.display = "block";
    } else {
      otherContainer.style.display = "none";
    }
  }
  
  

</script>
</body>

