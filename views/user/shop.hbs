<head>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
    rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/home.css" type="text/css">
    {{!-- toastify --}}
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">


<style>
 /* --------------------------------------------------- */
 /*  General & Base Styles */
 /* --------------------------------------------------- */

 .product.spad {
     padding-top: 50px;
     padding-bottom: 50px;
 }

 /* Main search bar styling */
 #mainSearch {
     border-radius: 6px;
     padding: 8px 12px;
     border: 1px solid #ccc;
     width: 100%;
     max-width: 300px;
     transition: border-color 0.3s, box-shadow 0.3s;
 }

 #mainSearch:focus {
     border-color: #233c79;
     box-shadow: 0 0 5px rgba(35, 60, 121, 0.3);
     outline: none;
 }

 /* --------------------------------------------------- */
 /* üíª Desktop Sidebar Styles */
 /* --------------------------------------------------- */
 .sidebar {
     background: #fff;
     padding: 25px;
     border-radius: 12px;
     box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
     position: sticky;
     top: 20px;
     transition: transform 0.3s ease, box-shadow 0.3s ease;
     max-height: calc(100vh - 40px);
     overflow-y: auto;
 }

 /* Custom scrollbar for sidebar */
 .sidebar::-webkit-scrollbar {
     width: 6px;
 }

 .sidebar::-webkit-scrollbar-track {
     background: #f1f1f1;
     border-radius: 10px;
 }

 .sidebar::-webkit-scrollbar-thumb {
     background: #233c79;
     border-radius: 10px;
 }

 .sidebar::-webkit-scrollbar-thumb:hover {
     background: #1a2c58;
 }

 /* Sidebar Items */
 .sidebar__item {
     margin-bottom: 35px;
     padding-bottom: 25px;
     border-bottom: 1px solid #e8e8e8;
 }

 .sidebar__item:last-child {
     border-bottom: none;
     margin-bottom: 0;
     padding-bottom: 0;
 }

 .sidebar__item h5 {
     font-size: 16px;
     font-weight: 700;
     margin-bottom: 18px;
     color: #1a1a1a;
     text-transform: uppercase;
     letter-spacing: 0.5px;
     position: relative;
     padding-left: 12px;
 }

 .sidebar__item h5::before {
     content: '';
     position: absolute;
     left: 0;
     top: 50%;
     transform: translateY(-50%);
     width: 4px;
     height: 18px;
     background: #233c79;
     border-radius: 2px;
 }

 /* Lists */
 .sidebar__item ul {
     list-style: none;
     padding: 0;
     margin: 0;
 }

 .sidebar__item ul li {
     margin-bottom: 10px;
 }

 .sidebar__item ul li a {
     color: #555;
     font-size: 14px;
     text-decoration: none;
     transition: all 0.3s ease;
     display: flex;
     align-items: center;
     padding: 8px 12px;
     border-radius: 6px;
     position: relative;
 }

 .sidebar__item ul li a::before {
     content: '‚Ä∫';
     margin-right: 8px;
     opacity: 0;
     transform: translateX(-5px);
     transition: all 0.3s ease;
     color: #233c79;
     font-weight: bold;
     font-size: 18px;
 }

 .sidebar__item ul li a:hover {
     color: #233c79;
     background: #f5f7fb;
     padding-left: 16px;
 }

 .sidebar__item ul li a:hover::before {
     opacity: 1;
     transform: translateX(0);
 }

 /* Active link styling */
 .sidebar__item ul li a.active {
     color: #233c79;
     background: #f5f7fb;
     font-weight: 600;
 }

 /* Dropdown (Sorting) */
 .sidebar__item select {
     width: 100%;
     font-size: 14px;
     padding: 12px 40px 12px 14px;
     border-radius: 8px;
     border: 1px solid #ddd;
     background-color: #fff;
     cursor: pointer;
     transition: all 0.3s ease;
     -webkit-appearance: none;
     -moz-appearance: none;
     appearance: none;
     background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2212%22%20height%3D%2212%22%20viewBox%3D%220%200%2012%2012%22%3E%3Cpath%20fill%3D%22%23233c79%22%20d%3D%22M10.293%203.293L6%207.586%201.707%203.293A1%201%200%2000.293%204.707l5%205a1%201%200%20001.414%200l5-5a1%201%200%2000-1.414-1.414z%22%2F%3E%3C%2Fsvg%3E");
     background-repeat: no-repeat;
     background-position: right 14px center;
     font-weight: 500;
     color: #333;
 }

 .sidebar__item select:hover {
     border-color: #233c79;
     background-color: #fafbfc;
 }

 .sidebar__item select:focus {
     border-color: #233c79;
     box-shadow: 0 0 0 3px rgba(35, 60, 121, 0.1);
     outline: none;
 }

 /* --------------------------------------------------- */
 /* üì± Mobile Toggle Button */
 /* --------------------------------------------------- */
 #sidebarToggle {
     background: linear-gradient(135deg, #233c79 0%, #1a2c58 100%);
     color: #fff;
     padding: 14px 24px;
     border-radius: 8px;
     cursor: pointer;
     border: none;
     font-weight: 600;
     font-size: 15px;
     transition: all 0.3s ease;
     box-shadow: 0 4px 12px rgba(35, 60, 121, 0.3);
     width: 100%;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 10px;
 }

 #sidebarToggle::before {
     content: '‚ò∞';
     font-size: 18px;
 }

 #sidebarToggle:hover {
     background: linear-gradient(135deg, #1a2c58 0%, #0f1a35 100%);
     box-shadow: 0 6px 16px rgba(35, 60, 121, 0.4);
     transform: translateY(-2px);
 }

 #sidebarToggle:active {
     transform: translateY(0);
     box-shadow: 0 2px 8px rgba(35, 60, 121, 0.3);
 }

 /* --------------------------------------------------- */
 /* üì± Mobile Responsive Styles (Max 991px) */
 /* --------------------------------------------------- */
 @media (max-width: 991px) {

     /* Mobile Sidebar - Off Canvas Menu */
     .sidebar {
         position: fixed;
         top: 0;
         left: 0;
         height: 100vh;
         width: 320px;
         max-width: 85vw;
         z-index: 9999;
         transform: translateX(-100%);
         overflow-y: auto;
         box-shadow: 5px 0 20px rgba(0, 0, 0, 0.3);
         padding: 20px;
         border-radius: 0;
         padding-top: 70px;
     }

     .sidebar.active {
         transform: translateX(0);
     }

     /* Close button for mobile sidebar */
     .sidebar::before {
         content: '√ó';
         position: fixed;
         top: 15px;
         right: 15px;
         width: 40px;
         height: 40px;
         background: #233c79;
         color: white;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 32px;
         cursor: pointer;
         z-index: 10000;
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
         line-height: 1;
         font-weight: 300;
     }

     /* Overlay */
     .overlay {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.7);
         z-index: 9998;
         backdrop-filter: blur(2px);
     }

     .overlay.active {
         display: block;
         animation: fadeIn 0.3s ease;
     }

     @keyframes fadeIn {
         from {
             opacity: 0;
         }

         to {
             opacity: 1;
         }
     }

     /* Adjust spacing */
     .col-lg-3.col-md-4 {
         margin-bottom: 20px;
     }

     /* Full width search on mobile */
     .d-flex.justify-content-end.mb-3 {
         justify-content: flex-start !important;
         flex-wrap: wrap;
         gap: 10px;
     }

     #mainSearch {
         width: 100%;
         max-width: none;
         flex: 1;
         min-width: 0;
     }

     /* Adjust sidebar items spacing for mobile */
     .sidebar__item {
         margin-bottom: 25px;
         padding-bottom: 20px;
     }

     .sidebar__item h5 {
         font-size: 15px;
     }

     .sidebar__item ul li a {
         font-size: 14px;
         padding: 10px 12px;
     }
 }

 /* Tablet adjustments */
 @media (max-width: 767px) {
     .sidebar {
         width: 280px;
     }

     .product.spad {
         padding-top: 30px;
         padding-bottom: 30px;
     }
 }

 /* Small mobile adjustments */
 @media (max-width: 480px) {
     .sidebar {
         width: 100%;
         max-width: 100vw;
     }

     #sidebarToggle {
         padding: 12px 20px;
         font-size: 14px;
     }
 }

 /* --------------------------------------------------- */
 /* üìÑ Pagination Styles */
 /* --------------------------------------------------- */
 .pagination {
     display: flex;
     justify-content: center;
     align-items: center;
     gap: 8px;
     padding: 40px 0;
     font-family: 'Nunito Sans', sans-serif;
     flex-wrap: wrap;
 }

 .page-btn, .page-number {
     background: #2a2a2a;
     color: #b0b0b0;
     border: none;
     min-width: 42px;
     height: 42px;
     display: flex;
     justify-content: center;
     align-items: center;
     padding: 0 10px;
     border-radius: 50%;
     font-size: 15px;
     text-decoration: none;
     transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
     cursor: pointer;
     box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5), -2px -2px 5px rgba(50, 50, 50, 0.2);
 }

 .page-btn i {
     font-size: 14px;
 }

 .page-btn:hover, .page-number:hover {
     background: #333;
     color: #fff;
     box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.5), inset -2px -2px 5px rgba(50, 50, 50, 0.2);
     transform: scale(1.05);
 }

 .page-number.current {
     background: linear-gradient(145deg, #333, #111);
     color: #fff;
     font-weight: bold;
     pointer-events: none;
     box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.8), inset -2px -2px 5px rgba(50, 50, 50, 0.3);
 }

 .page-btn[disabled] {
     opacity: 0.2;
     cursor: not-allowed;
     box-shadow: none;
     transform: none;
 }

 .dots {
     color: #666;
     font-size: 20px;
     line-height: 1;
 }

 @media (max-width: 480px) {
     .pagination {
         gap: 6px;
         padding: 30px 0;
     }

     .page-btn, .page-number {
         min-width: 36px;
         height: 36px;
         font-size: 14px;
     }
 }

/* üîπ Clear Filters Button Style */
.clear-filters-btn {
  display: inline-block;
  width: 100%;
  padding: 12px 15px;
  background: linear-gradient(135deg, #233c79, #0b2977);
  color: #fff;
  font-weight: 600;
  font-size: 15px;
  border: none;
  border-radius: 10px;
  margin-top: 10px;
  box-shadow: 0 4px 12px rgba(36, 48, 221, 0.4);
  transition: all 0.3s ease;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.clear-filters-btn:hover {
  background:linear-gradient(135deg, #24418b, #1346c5);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(36, 48, 221, 0.5);
}

.clear-filters-btn:active {
  transform: translateY(0);
  box-shadow: 0 3px 6px rgba(221, 36, 118, 0.3);
}

/* Make sure it looks nice on mobile too */
@media (max-width: 991px) {
  .clear-filters-btn {
    padding: 14px;
    font-size: 16px;
    border-radius: 8px;
  }
}



</style>

</head>

<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay"></div>

    <!-- Product Section Begin -->
    <section class="product spad">
        <div class="container">
            <div class="row">
                <!-- Sidebar Start -->
                <div class="col-lg-3 col-md-4">
                    <!-- Toggle button for mobile -->
                    <button id="sidebarToggle" class="d-lg-none">Filters & Sorting</button>

                    <div class="sidebar" id="sidebar">
                        <!-- Sorting -->
                        <div class="sidebar__item">
                            <h5>Sort By</h5>
                            <select id="sortProducts" onchange="applySort()">
                                <option value="default">Default</option>
                                <option value="low-high">Price: Low to High</option>
                                <option value="high-low">Price: High to Low</option>
                                <option value="newest">Newest First</option>
                            </select>
                        </div><br>

                        <!-- Category Filter -->
                        <div class="sidebar__item"><br>
                            <h5>Categories</h5>
                            <ul>
                                <li><a href="#" onclick="filterCategory('all')">All</a></li>
                                {{#each categories}}
                                <li><a href="#" onclick="filterCategory('{{this._id}}')">{{this.name}}</a></li>
                                {{/each}}
                            </ul>
                        </div>

                        <!-- Price Filter -->
                        <div class="sidebar__item">
                            <h5>Filter by Price</h5>
                            <div class="price-range">
                                <ul>
                                   <li><a href="#" onclick="filterPrice('0-1000')">‚Çπ0 - ‚Çπ1000</a></li>
                                   <li><a href="#" onclick="filterPrice('1000-2000')">‚Çπ1000 - ‚Çπ2000</a></li>
                                   <li><a href="#" onclick="filterPrice('2000-4000')">‚Çπ2000 - ‚Çπ4000</a></li>
                                   <li><a href="#" onclick="filterPrice('4000-8000')">‚Çπ4000 - ‚Çπ8000</a></li>
                                   <li><a href="#" onclick="filterPrice('8000+')">‚Çπ8000+</a></li>
                                   
                                </ul>
                            </div>
                        </div>
                        <!-- Clear Filters Button -->
                        <div class="sidebar__item mt-4 text-center">
                            <button class="clear-filters-btn" id="clearFilter" onclick="resetFilters()">üßπClear All Filters</button>
                        </div>

                    </div>
                </div>
                <!-- Sidebar End -->

                <!-- Product Grid Start -->
                <div class="col-lg-9 col-md-8">
                   
                    <input type="hidden" id="isFilter" value="{{isFilter}}">
                    {{#if isFilter}}
                    <div>
                        <p>Filters applied:
                        {{#if search}}
                            {{search}}
                        {{else if brand}}
                            Brand: {{#each brandNames}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
                        {{else if sort}}
                            Sorted by: {{sort}}
                        {{else if category}}
                            Category: {{category}}
                        {{else if price}}
                            Price: {{price}}
                        {{/if}}
                        </p>
                    </div>
                    {{/if}}

                    <!-- Top bar with search -->
                    <div class="d-flex justify-content-end mb-3">
                        <input type="text" class="form-control w-50" placeholder="Search products..." id="mainSearch"
                            value="{{search}}" onkeypress="if(event.key === 'Enter') searchProducts()">
                        <button class="btn btn-secondary ms-2" onclick="searchProducts()">Search</button>
                        <button class="btn btn-outline-danger ms-2" id="clearSearch" onclick="clearSearch()">Clear</button>
                    </div>

                    <div class="row product__filter">
                        {{#each products}}
                        <div class="col-lg-4 col-md-6 col-sm-6 mix new-arrivals">
                            <div class="product__item">
                                <a href="/productDetails?id={{this._id}}">
                                    <div class="product__item__pic set-bg" data-setbg="{{this.productImages.[0]}}">
                                    </div>
                                </a>
                                <div class="product__item__text">
                                    <h6>{{this.productName}}</h6>
                                    {{#if (includes ../wishlistProducts this._id)}}
                                    <a id="wishlist-{{this._id}}" class="add-cart">‚ù§Ô∏è Wishlisted</a>
                                    {{else}}
                                    <a href="#" id="wishlist-{{this._id}}" onclick="addWishlist(event,'{{this._id}}')" class="add-cart">+ Add to Wish
                                        list</a>
                                    {{/if}}
                                    {{#if (gt this.appliedOffer 0)}}
                                        <p style="color: red; font-weight:900; font-size:large">{{this.appliedOffer}}% off</p> 
                                    {{/if}}
                                    <h5>
                                        ‚Çπ{{this.salePrice}}
                                        <span style="text-decoration: line-through; color: #888;">
                                            ‚Çπ{{this.regularPrice}}
                                        </span>
                                    </h5>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
                <!-- Product Grid End -->
            </div>

            <!-- Pagination Start -->
            <div class="pagination">
                
                {{#if (gt totalPages 1)}}
                    {{#each (paginationRange currentPage totalPages)}}
                    <a 
                        href="?{{queryString (merge ../query (paginationQuery this))}}" 
                        class="page-number {{#if (eq this ../currentPage)}}current{{/if}}">
                        {{this}}
                    </a>
                    {{/each}}
                {{/if}}
            </div>
            <!-- Pagination End -->
        </div>
    </section>

<script src="js/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>

$(document).ready(function () {
    $('.set-bg').each(function () {
        const bg = $(this).data('setbg');
        if (bg) $(this).css('background-image', 'url(' + bg + ')');
    });

    // Sidebar toggle
    $('#sidebarToggle').click(function() {
        $('#sidebar').toggleClass('active');
        $('#overlay').toggleClass('active');
    });

    // Close sidebar by clicking the overlay
    $('#overlay').click(function() {
        $('#sidebar').removeClass('active');
        $(this).removeClass('active');
    });


    $('#sidebar').click(function(event) {
        // Only trigger on mobile view where the sidebar is fixed/off-canvas (max-width: 991px)
        if ($(window).width() <= 991 && $(this).hasClass('active')) {
            // Check if the click is in the general area of the 'X' or on the sidebar background
            // We use the event target to make sure we don't accidentally close when clicking links/inputs
            if (event.target === this || $(event.target).is('h5, a, select')) {
                 // A simple way to check if the click is near the 'X' button area (top 150px)
                 const rect = this.getBoundingClientRect();
                 const y = event.clientY - rect.top;
                 const x = event.clientX - rect.left;

                 // A heuristic check for the top-right corner on mobile
                 if (y < 70 && x > (rect.width - 70) ) {
                    $('#sidebar').removeClass('active');
                    $('#overlay').removeClass('active');
                 }
            }
        }
    });

});

document.addEventListener('DOMContentLoaded',()=>{
    const isFilter = document.getElementById('isFilter')?.value?.trim();
    const clearButton = document.getElementById('clearFilter');
    const mainSearch = document.getElementById('mainSearch')?.value?.trim()
    const clearSearch = document.getElementById('clearSearch')

    clearSearch.style.display='none'
    clearButton.style.display='none'
    
    if (isFilter && isFilter !== 'false' && isFilter !== '0') {
        clearButton.style.display='block'
    }
    if(mainSearch && mainSearch.length!==0){
        clearSearch.style.display='block'
    }
})

async function addWishlist(event,id){
    event.preventDefault();
    
    const wishlistCount=document.getElementById("wishlist-count")
    try{
        const res=await fetch(`/addWishlist/${id}`,{
        method:"POST",
        headers:{"Content-type":"application/json"}
    })

    const data=await res.json()


    if(res.ok && data.success){
        Toastify({
            text: "Added to wishlist",
            duration: 3000,
            close: true,          
            gravity: "top",
            position: "center",    
            style: {
                background: "linear-gradient(to right, #0f2027, #203a43, #2c5364)", 
            },
            className: "custom-toast", 
            onClick: () => {     
                alert("Toast clicked!");
        }
        }).showToast();
    document.getElementById(`wishlist-${id}`).innerHTML="‚ù§Ô∏è Wishlisted"
    /* wishlistBtn.onclick = null;
    wishlistBtn.removeAttribute("onclick");
    wishlistBtn.style.pointerEvents = "none"; */
    wishlistCount.innerHTML=data.wishlistCount


    }else {
            // Show error toast (already in wishlist or other error)
            Toastify({
                text: data.message || "Error adding to wishlist",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "center",
                style: {
                    background: "linear-gradient(to right, #ff0000, #800000)", // red gradient for errors
                }
            }).showToast();
        }

    }catch(error){
        console.error("Wishlist error:", error);
        Toastify({
            text: "Network error. Please try again",
            duration: 3000,
            close: true,
            gravity: "top",
            position: "center",
            style: {
                background: "linear-gradient(to right, #ff0000, #800000)",
            }
        }).showToast();
    }
    
}


function searchProducts() {
    const query = document.getElementById("mainSearch").value.trim();
    const url = new URL(window.location.href);
    if (query) url.searchParams.set("search", query);
    else url.searchParams.delete("search");
    window.location.href = url.toString();
}

function clearSearch() {
    const searchInput = document.getElementById("mainSearch");
    searchInput.value = ""; // Clear input box
    const url = new URL(window.location.href);
    url.searchParams.delete("search"); // Remove 'search' from query string
    window.location.href = url.toString(); // Reload without search
}


function filterBrand() {
    const selectedBrands = Array.from(document.querySelectorAll("input[type=checkbox]:checked"))
        .map((el) => el.value);
    const url = new URL(window.location.href);
    url.searchParams.delete("brand");
    selectedBrands.forEach((brand) => url.searchParams.append("brand", brand));
    window.location.href = url.toString();
}

function applySort() {
    const sortValue = document.getElementById("sortProducts").value;
    const url = new URL(window.location.href);
    url.searchParams.set("sort", sortValue);
    window.location.href = url.toString();
}

function filterCategory(categoryId) {
  const url = new URL(window.location.href);
  if (categoryId && categoryId !== 'all') {
    url.searchParams.set("category", categoryId);
  } else {
    url.searchParams.delete("category");
  }
  url.searchParams.set("page", 1); // reset pagination
  window.location.href = url.toString();
}

function filterPrice(priceRange) {
  const url = new URL(window.location.href);
  if (priceRange) {
    url.searchParams.set("price", priceRange);
  } else {
    url.searchParams.delete("price");
  }
  url.searchParams.set("page", 1);
  window.location.href = url.toString();
}

function resetFilters() {
    const url = new URL(window.location.href);
    // Remove all filter-related query parameters
    const filterParams = ["search", "brand", "sort", "category", "price", "page"];
    filterParams.forEach(param => url.searchParams.delete(param));
    // Reload page
    window.location.href = url.pathname; 
}


</script>
</body>